<!DOCTYPE html>
<html class="nb_fullscreen">
  <head>
<!--
   Author: cf AUTHORS.txt 
   License:  Copyright (c) 2010-2012 Massachusetts Institute of Technology.
   MIT License (cf. MIT-LICENSE.txt or http://www.opensource.org/licenses/mit-license.php)
  -->
    <title>NB Analytics</title>
    <link type="text/css" href="/content/compiled/docanalytics.css" rel="stylesheet" />
    <script type="text/javascript" src="/content/compiled/docanalytics_NB.js"></script>
    <script type="text/template" id="page-template">
      <a href="/f/{{ source.id }}?p=<%=page_num%>" target="_blank">
        <div id="page-preview-<%= page_num %>">
          <img class="page-img" id="page-img-<%= page_num %>" src="<%= img_url %>">
        </div>
      </a>
        <span class="page-num page-label"><%= page_num %></span>
        <div class="page-stats">
          <span class="threads color-stat"><span class="val"><%= num_threads %></span> threads</span>
          <br/><span class="annotations color-stat"><span class="val"><%= num_annotations %></span> annotations</span>
          <br/><span class="questions color-stat"><span class="val"><%= num_questions %></span> questions</span>
          <br/><span class="participants color-stat"><span class="val"><%= num_participants %></span> participants</span>
        </div>
        <div class="clearfix"></div>
    </script>
    <script type="text/template" id="highlight-template">
      <div class="highlight" style="top:<%= y %>px; left:<%= x %>px; width: <%= w %>px; height: <%= h %>px;">
        <div class="marker"></div>
      </div>
    </script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script>
      // For logging
      window.onload = function() {
        var key = {{ source.id }}+"|"+(new Date()).getTime();
        var payload = {};
        payload[key]=(new Date()).getTime();
        NB.pers.call("log_history", {"analytics": payload}, function(callback) {
          console.log("logged");
        });
      };
    </script>
    <script type="text/javascript">
      var chart_stats = {{ chart_stats|safe }};
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        // ANNOTATIONS CHART
        var data = new google.visualization.DataTable();
        data.addColumn('string','Page');
        data.addColumn('number','Threads');
        data.addColumn('number','Annotations');
        data.addColumn('number','Replies requested');
        data.addColumn('number', 'Participants');
        data.addColumn('number', 'Total time');
        data.addColumn('number', 'Avg time');
        data.addRows(chart_stats);
        
        var options = {
          title: 'Page Stats',
          hAxis: {title: 'Page'},
          // colors: ["blue", '#3366CC', '#DC3912', '#E19900', '#109618']
          // series: {
          //   1: {
          //     color: '#3366CC'
          //   },
          //   2: {
          //     color: '#DC3912' 
          //   },
          //   3: {
          //     color: '#E19900'
          //   }
          // }
        };

        data.setColumnProperty(1, "allowHtml", "true");
        data.setColumnProperty(1, "style", "color:yellow");
        data.setColumnProperty(1, "style", "background-color:yellow");


        var view = new google.visualization.DataView(data);
        view.setColumns([0,1,2,3]);

        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart.draw(view, options);

        var formatter = new google.visualization.ColorFormat();
        formatter.addRange(null, null, 'yellow', 'yellow');
        formatter.format(data,1);

        (function($){
          var metrics_on = [0,1,2,3];
          var colors_on = [];
          var metric_mapping = {
            "Threads": 1,
            "Annotations": 2,
            "Replies Requested": 3,
            "Participants": 4,
            "Total Time": 5,
            "Average Time": 6
          };
          var color_mapping = {
            0: "blue",
            1: '#3366CC', 
            2: '#DC3912', 
            3: '#E19900', 
            4: '#109618',
            5: 'red',
            6: 'red'
          };
          $(".chart-toggle").on("click", function() {
            var metric = $(this).val();
            var num = metric_mapping[metric];
            console.log(num);
            console.log("metrics on before: "+metrics_on);
            var i = $.inArray(num, metrics_on);
            if (i > -1) {
              console.log("turning off");
              metrics_on.splice(i, 1);
              $(this).removeClass("on");
            } else {
              console.log("turning on");
              metrics_on.push(num);
              $(this).addClass("on");
            }
            console.log(metrics_on);
            view.setColumns(metrics_on);
            // colors_on = [];
            // for (var i=0; i++; i<metrics_on.length) {
            //   console.log(color_mapping[metrics_on[i]]);
            //   colors_on.push(color_mapping[metrics_on[i]]);
            // }
            // console.log(colors_on);
            // options.colors = colors_on;
            chart.draw(view, options);
          });

          var pgLabelClass = 'page-label';
          var pgPreviewClass = 'pg-preview';

          $('text').each(function(i, el) {
            var obj = $(el);
            var n = obj.text();
            if ($.isNumeric(n)) {
              obj.attr('class', pgLabelClass);
            }
          });

          // TODO: move this out of drawChart() function
          $('.'+pgLabelClass).on({
            mouseenter: function() {
              var num = $(this).text();
              var contents = $('#page-preview-'+num).html();
              $('.'+pgPreviewClass).html(contents);

              // get the larger image for the preview
              var img_server = "http://nb.mit.edu";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/72/100/"+{{ source.id }}+"?ckey="+ckey+";page=" + num;
              $('.'+pgPreviewClass).find('.page-img').attr("src", img_url);

              $('.'+pgPreviewClass).children(".highlight").each(function(i, el) {
                var s = 5;  // scale factor (for res 20 images)
                $(el).height($(el).height()*s);
                $(el).width($(el).width()*s);
                $(el).css("top", $(el).css("top").replace(/[^-\d\.]/g, '')*s);
                $(el).css("left", $(el).css("left").replace(/[^-\d\.]/g, '')*s);
              });
              $('.'+pgPreviewClass).show();
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

          // to avoid flicker when preview overlaps page number 
          $('.'+pgPreviewClass).on({
            mouseenter: function() {
              $('.'+pgPreviewClass).show();
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

        })(jQuery); 
      }

    </script>
    <script type="text/javascript" src="/content/modules/dev/ui.docAnalyticsBackboneViews.js"></script>

    <script>
      (function($){
        $(document).ready(function() {
            var pages = {{ pages|safe }};
            var highlights = {{ highlights|safe }};
            var doc = new Document();
            
            var orientation;
            if ({{ source.h }} > {{ source.w }}) {
              orientation = "portrait";
            } else {
              orientation = "landscape";
            };

            var page;

            for (p in pages) {
              page = new Page(pages[p]);  

              // TODO: better way to get the source ID/ckey?
              var img_server = "http://nb.mit.edu";
              // var img_server = "";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/72/20/"+{{ source.id }}+"?ckey="+ckey+";page=" + p;
              page.set('img_url', img_url); // TODO: put img url in PageView?

              doc.add(page);
            }

            var documentView = new DocumentView({
              collection: doc,
              el: $("#pages-container"),
            });
            documentView.render();

            for (h in highlights) {
              var highlight = new Highlight(highlights[h]);
              highlight.set("page_orientation", orientation);
              var highlightView = new HighlightView({ model: highlight});
            }

            $(".color-stat").each(function(i, el) {
              var val = $(el).children(".val").text();
              var o = 1.0;
              var c = rgb2hex($(el).css("color"));
              var newC;
              // gradients set by arbitrary intervals // TODO make them different for each metric?
              if (val > 0) {
                $(el).css("opacity", o);
                if (val < 10) {
                  newC = LightenDarkenColor(c, 10);
                } 
                else if (val < 20) {
                  // newC = LightenDarkenColor(c, -20);
                } else if (val < 30) {
                  newC = LightenDarkenColor(c, -10);
                } else {
                  newC = LightenDarkenColor(c, -20);
                }
                $(el).css("color", newC);
              }
            });

            /////////////// handlers

            $("#sort-by").on('change', function() {
              var attr = $(this).val();
              doc.sortByField(attr);
            })

            $("#show-filter").on('change', function() {
              var property = $(this).val();
              var num = 0; // TODO: make this flexible (another HTML property?)
              documentView.filterByPropertyAndNum(property, num);
            })
        });
      })(jQuery);
    </script>


  </head>
  <body>
    <div class='nb-viewport'><div class='nb-widget-header' style='height:24px;' /></div>
    <div class="main-wrapper">
      <h1><a href="/f/{{ source.id }}" class="header-link">{{ source.title }}</a></h1>
      
      <div id="chart_div"></div>
      <div id="chart-controls">
        <!-- Show: <input type="button" class="chart-toggle annotations" value="Annotations"/>Annotations -->
        <button class="chart-toggle annotations on" value="Annotations">Annotations</button>
        <input type="checkbox" class="chart-toggle" checked value="Threads"/>Threads
        <input type="checkbox" class="chart-toggle" checked value="Replies Requested"/>Replies Requested
        <input type="checkbox" class="chart-toggle" value="Participants"/>Participants
        <input type="checkbox" class="chart-toggle" value="Total Time"/>Total Time
        <input type="checkbox" class="chart-toggle" value="Average Time"/>Average Time
      </div>
      <div id="time_chart_div"></div>
      <hr>
      <div class="controls">
        <label>Show: </label>
        <select id="show-filter">
          <option value="all">All pages</option>
          <option value="annotations">Pages with annotations</option>
          <option value="questions">Pages with replies requested</option>
        </select>
      
        <label>Sort by: </label>
        <select id="sort-by">
          <option value="page_num">Page number</option>
          <option value="num_threads">Number of threads</option>
          <option value="num_annotations">Number of annotations</option>
          <option value="num_questions">Number of replies requested</option>
          <option value="num_participants">Number of participants</option>
        </select>
      </div>

      <span class="tip">
        Hover over page numbers for enlarged views. Click page images to view annotations in NB.
      </span>

      <div id="pages-container"></div>
      <div class="clearfix"></div>
    </div>

    <div class="pg-preview"><img class="img-enlarged" /></div>


  </body>
</html>
